//////////////////////////////////////
//  ****       Constants      ****  //
//////////////////////////////////////

//Page Integration constants
var DIVNAME="csljs"; //Name of the div containing Carousel
var ID_NAMESPACE="carousel_image_id_";  //To distinguish this app's ids with the rest of the ids used by the site

//Parameters
var RANDOMIZE=true; //Sets whether or not image order randomization should occur
var SLIDESPEED=1000;    //Sets the sliding speed of the images
var AUTOSLIDE=true;    //Sets whether or not the images will automatcally slide automatically.
var AUTOSLIDESPEED=6000;    //Sets how often the images will autoslide.
var IMAGELIST="slideshow.txt"   //Sets the file that contains the image urls that the slideshow will scroll through


//////////////////////////////////////
//  ****       Variables      ****  //
//////////////////////////////////////
var curr_index=0;
var autoslide_interval;

//////////////////////////////////////
//  ****   Helper Functions   ****  //
//////////////////////////////////////


//Script Components
//-----------------

function carouselInit(){
  curr_index=getNextImageIndex();
  container.html("\
      <div style='position:relative;width:"+containerWidth+";height:"+containerHeight+";' onMouseOver='$(\"#"+ID_NAMESPACE+"_whatis\").fadeTo(200,0.3)' onMouseLeave='$(\"#"+ID_NAMESPACE+"_whatis\").fadeTo(200,1)' >\
        <div style='position:absolute'>\
          <div style='border:1px solid black;width:"+containerWidth+";height:"+containerHeight+"; white-space:nowrap;overflow:hidden'>\
            <div id='"+DIVNAME+"_images' height="+containerHeight+">"
              +genImageHtml(imageUrls[curr_index],1759)+
            "</div>\
          </div>\
        </div>\
        <div style='position:absolute;text-align:left; left:10%; top:20%; width:60%; height:auto; background-color:rgba(0,0,0,0.5);;' id='"+ID_NAMESPACE+"_whatis'>\
          <div style='position:relative; color:white; padding:1em; font-family: \"Puritan\",\"Lucinda Grande\"Helvetica,Arial,serif;font-size: 0.9em;line-height: 1.3em; color:white;'>\
            Eta Kappa Nu (HKN) is the <a style='color: #F7E26B;' href='http://www.hkn.org/'>national Electrical and Computer Engineering honor society</a>.\
            The Berkeley chapter is among the most active engineering societies at Berkeley, providing academic services to fellow undergraduates.\
            Our two offices are located in 290 Cory and 345 Soda near the <a style='color: #F7E26B;' href='http://berkeley.edu/map/maps/AB45.html'>northeastern corner of the UC Berkeley campus</a>.\
          </div>\
        </div>\
        <div style='position:absolute;text-align:center; right:0%; width:10%; height:100%; background-color:black;;opacity:0;' onMouseOver='$(this).fadeTo(200,.7)' onMouseLeave='$(this).fadeTo(200,0)' id='"+ID_NAMESPACE+"_rightButton'>\
          <div style='position:relative; top:50%; margin-top:-.3em; color:white; font-size:5em;'>⟩</div>\
        </div>\
        <div style='position:absolute;text-align:center; left:0%; width:10%; height:100%; background-color:black;;opacity:0;' onMouseOver='$(this).fadeTo(200,.7)' onMouseLeave='$(this).fadeTo(200,0)' id='"+ID_NAMESPACE+"_leftButton'>\
          <div style='position:relative; top:50%; margin-top:-.3em; color:white; font-size:5em;'>⟨</div>\
        </div>\
      </div>");
  $("#"+ID_NAMESPACE+"_rightButton").click(nextImage);
  $("#"+ID_NAMESPACE+"_leftButton").click(prevImage);
  if (AUTOSLIDE){
    autoslide_interval=setInterval(nextImage,AUTOSLIDESPEED);
  }
}

xcor=0;
boundary_xcor=0;
function nextImage(){
  xcor-=containerWidth;
  if (xcor<boundary_xcor){
    boundary_xcor=xcor;
    addImage();
  }
  boundary_xcor=Math.min(xcor,boundary_xcor);
  $("#"+DIVNAME+"_images").animate({"margin-left": xcor}, SLIDESPEED);
}

function prevImage(){
  if (xcor<0){
    xcor+=containerWidth;
    $("#"+DIVNAME+"_images").animate({"margin-left": xcor}, SLIDESPEED);
    curr_index--;
  }
}

function addImage(){
  curr_index=getNextImageIndex();
  $("#"+DIVNAME+"_images").append(genImageHtml(imageUrls[curr_index],0));
}

function genImageHtml(url,index){
  return format("<img src='{0}' id='{1}' width='{2}' height='{3}'/>",[url,ID_NAMESPACE+String(index),String(containerWidth),String(containerHeight)]);
}

//Utilities
//---------

//Gets the next image Index
//Make sure the same image does not occuur twice.
var currIndex=0;
var prevIndex=0;
function getNextImageIndex(){
  if (RANDOMIZE){
    if (imageUrls.length==0){
      return 0;
    }
    if (imageUrls.length==1){
      return 0;
    }
    while (currIndex==prevIndex){
      currIndex=randInt(imageUrls.length);
    }
    prevIndex=currIndex;
    return currIndex;
  }else{
    prevIndex=currIndex;
    currIndex++;
    //Pointless Comment
    if (currIndex>=imageUrls.length){
      currIndex=0;
    }
    return prevIndex;
  }
}

function format(s, args) {
  var re = /\{([^}]+)\}/g;
  return s.replace(re, function(_, match){ return args[match]; });
}

function randInt(upBound){
  return Math.floor(upBound*Math.random());
}

//JQuery Extensions
jQuery.fn.extend({
  slideRightShow: function() {
    return this.each(function() {
      $(this).show('slide', {direction: 'right'}, 1000);
    });
  },
  slideLeftHide: function() {
    return this.each(function() {
      $(this).hide('slide', {direction: 'left'}, 1000);
    });
  },
  slideRightHide: function() {
    return this.each(function() {
      $(this).hide('slide', {direction: 'right'}, 1000);
    });
  },
  slideLeftShow: function() {
    return this.each(function() {
      $(this).show('slide', {direction: 'left'}, 1000);
    });
  }
});

//////////////////////////////////////
//  ****   Generate Carousel  ****  //
//////////////////////////////////////

//Obtain Data on the Carousel container
var container=$("#"+DIVNAME);
var containerWidth=Number(container.css("width").substr(0,container.css("width").length-2));
var containerHeight=Number(container.css("height").substr(0,container.css("height").length-2));
container.mouseenter(function(){
  clearInterval(autoslide_interval);
})
container.mouseleave(function(){
  if (AUTOSLIDE){
    autoslide_interval=setInterval(nextImage,AUTOSLIDESPEED);
  }
})

//Get images. Located in the file especified by the parameter IMAGELIST
x = new XMLHttpRequest();
x.open("GET",IMAGELIST,false);
x.send();
var imageUrls=['https://hkn.eecs.berkeley.edu/gallery3/var/albums/Spring-2013/Pi-Day-and-Board-Game-Night/010.JPG?m=1363397782',
'https://hkn.eecs.berkeley.edu/gallery3/var/resizes/Spring-2013/Pi-Day-and-Board-Game-Night/011.JPG?m=1363397789',
'https://hkn.eecs.berkeley.edu/gallery3/var/resizes/Spring-2013/Pi-Day-and-Board-Game-Night/012.JPG?m=1363397795',
'https://hkn.eecs.berkeley.edu/gallery3/var/resizes/Spring-2013/Pi-Day-and-Board-Game-Night/013.JPG?m=1363397801',
'https://hkn.eecs.berkeley.edu/gallery3/var/resizes/Spring-2013/Pi-Day-and-Board-Game-Night/014.JPG?m=1363397806',]
carouselInit();
